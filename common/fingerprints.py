
_FINGERPRINTS = {
  "ACURA ILX 2016 ACURAWATCH PLUS": {
    1024L: 5, 513L: 5, 1027L: 5, 1029L: 8, 929L: 4, 1057L: 5, 777L: 8, 1034L: 5, 1036L: 8, 398L: 3, 399L: 7, 145L: 8, 660L: 8, 985L: 3, 923L: 2, 542L: 7, 773L: 7, 800L: 8, 432L: 7, 419L: 8, 420L: 8, 1030L: 5, 422L: 8, 808L: 8, 428L: 8, 304L: 8, 819L: 7, 821L: 5, 57L: 3, 316L: 8, 545L: 4, 464L: 8, 1108L: 8, 597L: 8, 342L: 6, 983L: 8, 344L: 8, 804L: 8, 1039L: 8, 476L: 4, 892L: 8, 490L: 8, 1064L: 7, 882L: 2, 884L: 7, 887L: 8, 888L: 8, 380L: 8, 1365L: 5,
    # sent messages
    0xe4: 5, 0x1fa: 8, 0x200: 3, 0x30c: 8, 0x33d: 5,
  },
  "HONDA CIVIC 2016 TOURING": {
    1024L: 5, 513L: 5, 1027L: 5, 1029L: 8, 777L: 8, 1036L: 8, 1039L: 8, 1424L: 5, 401L: 8, 148L: 8, 662L: 4, 985L: 3, 795L: 8, 773L: 7, 800L: 8, 545L: 6, 420L: 8, 806L: 8, 808L: 8, 1322L: 5, 427L: 3, 428L: 8, 304L: 8, 432L: 7, 57L: 3, 450L: 8, 929L: 8, 330L: 8, 1302L: 8, 464L: 8, 1361L: 5, 1108L: 8, 597L: 8, 470L: 2, 344L: 8, 804L: 8, 399L: 7, 476L: 7, 1633L: 8, 487L: 4, 892L: 8, 490L: 8, 493L: 5, 884L: 8, 891L: 8, 380L: 8, 1365L: 5,
    # sent messages
    0xe4: 5, 0x1fa: 8, 0x200: 3, 0x30c: 8, 0x33d: 5, 0x35e: 8, 0x39f: 8,
  },
  "HONDA ACCORD 2016 TOURING": {
    1024L: 5, 929L: 8, 1027L: 5, 773L: 7, 1601L: 8, 777L: 8, 1036L: 8, 398L: 3, 1039L: 8, 401L: 8, 145L: 8, 1424L: 5, 660L: 8, 661L: 4, 918L: 7, 985L: 3, 923L: 2, 542L: 7, 927L: 8, 800L: 8, 545L: 4, 420L: 8, 422L: 8, 808L: 8, 426L: 8, 1029L: 8, 432L: 7, 57L: 3, 316L: 8, 829L: 5, 1600L: 5, 1089L: 8, 1057L: 5, 780L: 8, 1088L: 8, 464L: 8, 1108L: 8, 597L: 8, 342L: 6, 983L: 8, 344L: 8, 804L: 8, 476L: 4, 1296L: 3, 891L: 8, 1125L: 8, 487L: 4, 892L: 8, 490L: 8, 871L: 8, 1064L: 7, 882L: 2, 884L: 8, 506L: 8, 507L: 1, 380L: 8, 1365L: 5
  },
  "HONDA CR-V 2016 TOURING": {
    57L: 3, 145L: 8, 316L: 8, 340L: 8, 342L: 6, 344L: 8, 380L: 8, 398L: 3, 399L: 6, 401L: 8, 420L: 8, 422L: 8, 426L: 8, 432L: 7, 464L: 8, 474L: 5, 476L: 4, 487L: 4, 490L: 8, 493L: 3, 507L: 1, 542L: 7, 545L: 4, 597L: 8, 660L: 8, 661L: 4, 773L: 7, 777L: 8, 800L: 8, 804L: 8, 808L: 8, 882L: 2, 884L: 7, 888L: 8, 891L: 8, 892L: 8, 923L: 2, 929L: 8, 983L: 8, 985L: 3, 1024L: 5, 1027L: 5, 1029L: 8, 1033L: 5, 1036L: 8, 1039L: 8, 1057L: 5, 1064L: 7, 1108L: 8, 1125L: 8, 1296L: 8, 1365L: 5, 1424L: 5, 1600L: 5, 1601L: 8,
    # sent messages
    0x194: 4, 0x1fa: 8, 0x30c: 8, 0x33d: 5,
  },
  "CHEVROLET VOLT 2017 PREMIER": {
    0xa1L: 7, 0x106L: 5, 0x300: 8, 0x302L: 2, 0x303L: 2, 0x310L: 2, 0x308L: 7, 0x306L: 8, 0x510L: 7, 0x512L: 8, 0x511L: 8, 0x513L: 8, 0x514L: 8, 0x515L: 8, 0x516L: 8, 0x517L: 8, 0x518L: 8, 0x519L: 8, 0x51aL: 8, 0x51bL: 8, 0x51cL: 8, 0x51dL: 8, 0x51eL: 8, 0x51fL: 8, 0x521L: 7, 0x522L: 7, 0x523L: 7, 0x524L: 7, 0x525L: 7, 0x526L: 7, 0x527L: 7, 0x528L: 7, 0x529L: 7, 0x475L: 8, 0x476L: 8, 0x477L: 8, 0x47aL: 8, 0x47bL: 8, 0x47cL: 8, 0x47dL: 8, 0x47eL: 8, 0x47fL: 8, 0x530L: 8, 0x533L: 8, 0x537L: 8, 0x52aL: 7, 0x52bL: 7, 0x52cL: 7, 0x52dL: 7, 0x52eL: 7, 0x52fL: 7, 0x460L: 8, 0x461L: 8, 0x462L: 8, 0x463L: 8, 0x464L: 8, 0x465L: 8, 0x466L: 8, 0x467L: 8, 0x468L: 8, 0x469L: 8, 0x46aL: 8, 0x46bL: 8, 0x46cL: 8, 0x46dL: 8, 0x46eL: 8, 0x46fL: 8, 0x470L: 8, 0x471L: 8, 0x472L: 8, 0x473L: 8, 0x474L: 8, 0x552L: 8, 0x580L: 8, 0x582L: 6, 0x584L: 8, 0x585L: 5, 0x581L: 8, 0x586L: 7, 0x53aL: 8, 0x540L: 8, 0x741L: 8, 0x743L: 8, 0x780L: 7, 0x135L: 1, 0x409L: 7, 0x40aL: 7, 0x420L: 6, 0x421L: 8, 0x422L: 8, 0x423L: 8, 0x424L: 8, 0x425L: 8, 0x426L: 8, 0x427L: 8, 0x428L: 8, 0x429L: 8, 0x42aL: 8, 0x42bL: 8, 0x42cL: 8, 0x440L: 8, 0x441L: 8, 0x442L: 8, 0x443L: 8, 0x444L: 8, 0x445L: 8, 0x446L: 8, 0x447L: 8, 0x448L: 8, 0x449L: 8, 0x44aL: 8, 0x44bL: 8, 0x44cL: 8, 0x350L: 8, 0x351L: 8, 0x352L: 8, 0x353L: 8, 0x354L: 8, 0x355L: 8, 0x356L: 3,

    # Forwarded from powertrain
    0xbdL: 7, 0xbeL: 6, 0xf1L: 6, 0x135L: 8, 0x184L: 8, 0x1e5L: 8, 0x348L: 5, 0x34aL: 5
  }
}

def eliminate_incompatible_cars(msg, candidate_cars):
  """Removes cars that could not have sent msg.

     Inputs:
      msg: A cereal/log CanData message from the car.
      candidate_cars: A list of cars to consider.

     Returns:
      A list containing the subset of candidate_cars that could have sent msg.
  """
  compatible_cars = []
  for car_name in candidate_cars:
    adr = msg.address
    if msg.src != 0 or (adr in _FINGERPRINTS[car_name] and
                        _FINGERPRINTS[car_name][adr] == len(msg.dat)):
      compatible_cars.append(car_name)
    else:
      pass
      #isin = adr in _FINGERPRINTS[car_name]
      #print "eliminate", car_name, hex(adr), isin, len(msg.dat), msg.dat.encode("hex")
  return compatible_cars

def all_known_cars():
  """Returns a list of all known car strings."""
  return _FINGERPRINTS.keys()

# **** for use live only ****
def fingerprint(logcan):
  import selfdrive.messaging as messaging
  from cereal import car
  from common.realtime import sec_since_boot
  import os
  if os.getenv("SIMULATOR") is not None or logcan is None:
    # send message
    ret = car.CarParams.new_message()

    ret.carName = "simulator"
    ret.radarName = "nidec"
    ret.carFingerprint = "THE LOW QUALITY SIMULATOR"

    ret.enableSteer = True
    ret.enableBrake = True
    ret.enableGas = True
    ret.enableCruise = False

    ret.wheelBase = 2.67
    ret.steerRatio = 15.3
    ret.slipFactor = 0.0014

    ret.steerKp, ret.steerKi = 12.0, 1.0
    return ret

  print "waiting for fingerprint..."
  brake_only = True

  candidate_cars = all_known_cars()
  finger = {}
  st = None
  while 1:
    for a in messaging.drain_sock(logcan, wait_for_one=True):
      if st is None:
        st = sec_since_boot()
      for can in a.can:
        # pedal
        if can.address == 0x201 and can.src == 0:
          brake_only = False
        if can.src == 0:
          finger[can.address] = len(can.dat)
        candidate_cars = eliminate_incompatible_cars(can, candidate_cars)

    # if we only have one car choice and it's been 100ms since we got our first message, exit
    if len(candidate_cars) == 1 and st is not None and (sec_since_boot()-st) > 0.1:
      break
    elif len(candidate_cars) == 0:
      for addr, length in finger.iteritems():
        print "%#xL: %d," % (addr, length),
      raise Exception("car doesn't match any fingerprints")

  fingerprinted = candidate_cars[0]
  print "fingerprinted", fingerprinted

  # send message
  ret = car.CarParams.new_message()
  ret.carFingerprint = fingerprinted

  if fingerprinted == "HONDA CIVIC 2016 TOURING":
    ret.carName = "honda"
    ret.steerKp, ret.steerKi = 12.0, 1.0
  elif fingerprinted == "ACURA ILX 2016 ACURAWATCH PLUS":
    ret.carName = "honda"
    if not brake_only:
      # assuming if we have an interceptor we also have a torque mod
      ret.steerKp, ret.steerKi = 6.0, 0.5
    else:
      ret.steerKp, ret.steerKi = 12.0, 1.0
  elif fingerprinted == "HONDA ACCORD 2016 TOURING":
    ret.carName = "honda"
    ret.steerKp, ret.steerKi = 12.0, 1.0
  elif fingerprinted == "HONDA CR-V 2016 TOURING":
    ret.carName = "honda"
    ret.steerKp, ret.steerKi = 6.0, 0.5
  elif fingerprinted == "CHEVROLET VOLT 2017 PREMIER":
    ret.carName = "gm"
  else:
    raise ValueError("unsupported car %s" % candidate_cars[0])

  if ret.carName == "honda":
    ret.radarName = "nidec"

    ret.enableSteer = True
    ret.enableBrake = True
    ret.enableGas = not brake_only
    ret.enableCruise = brake_only
    #ret.enableCruise = False

    ret.wheelBase = 2.67
    ret.steerRatio = 15.3
    ret.slipFactor = 0.0014

  elif ret.carName == "gm":
    ret.radarName = "continental"

    brake_only = False
    ret.enableSteer = True
    ret.enableBrake = True
    ret.enableGas = not brake_only
    ret.enableCruise = brake_only

    ret.wheelBase = 2.69
    ret.steerRatio = 15.7
    ret.slipFactor = 0.0014

    ret.steerKp = 5.5
    ret.steerKi = 0.35

    return ret

  else:
    raise ValueError("unsupported car name %s" % ret.carName)
